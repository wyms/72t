<!doctype html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VFNFGEXSFD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-VFNFGEXSFD');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IRS Rule 72(t) SEPP Calculator</title>
  <meta
    name="description"
    content="Calculate Substantially Equal Periodic Payments (SEPP) for penalty-free early IRA withdrawals using IRS-approved methods: RMD, Amortization, and Annuitization."
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #1e40af;
      --primary-light: #3b82f6;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --success: #059669;
      --warning: #d97706;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }

    header { text-align: center; margin-bottom: 2rem; }

    h1 {
      font-size: 1.875rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .subtitle { color: var(--text-muted); font-size: 1rem; }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .form-group { display: flex; flex-direction: column; }

    label {
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.375rem;
      color: var(--text);
    }

    input, select {
      padding: 0.625rem 0.875rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .help-text { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
      width: 100%;
      margin-top: 1rem;
    }

    .btn:hover { background: var(--primary-light); }
    .btn:active { transform: scale(0.98); }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }

    @media (max-width: 640px) {
      .results-grid { grid-template-columns: 1fr; }
    }

    .result-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 10px;
      padding: 1.25rem;
      color: white;
      text-align: center;
    }

    .result-card.rmd { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
    .result-card.amortization { background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%); }
    .result-card.annuitization { background: linear-gradient(135deg, #dc2626 0%, #f87171 100%); }

    .result-method {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.9;
      margin-bottom: 0.25rem;
    }

    .result-amount { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
    .result-monthly { font-size: 0.875rem; opacity: 0.9; }

    .info-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    @media (max-width: 640px) { .info-grid { grid-template-columns: 1fr; } }

    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px dashed var(--border);
    }

    .info-label { color: var(--text-muted); font-size: 0.875rem; }
    .info-value { font-weight: 600; font-size: 0.875rem; }

    .warning-box {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .warning-box h4 { color: #92400e; font-size: 0.875rem; margin-bottom: 0.5rem; }
    .warning-box p { color: #92400e; font-size: 0.8125rem; }

    .disclaimer {
      background: #f1f5f9;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .rate-info {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.8125rem;
    }

    .rate-info strong { color: var(--primary); }

    .hidden { display: none; }

    .method-descriptions { display: grid; gap: 0.75rem; margin-top: 1rem; }

    .method-desc {
      padding: 0.75rem;
      background: #f8fafc;
      border-radius: 6px;
      font-size: 0.8125rem;
    }

    .method-desc h5 { font-weight: 600; margin-bottom: 0.25rem; }

    .sepp-duration {
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      text-align: center;
    }

    .sepp-duration h4 { color: #065f46; font-size: 0.875rem; margin-bottom: 0.25rem; }
    .sepp-duration .duration { font-size: 1.25rem; font-weight: 700; color: #059669; }

    a { color: var(--primary-light); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .inline-note {
      margin-top: 0.75rem;
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .chart-container {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
      position: relative;
      height: 400px;
    }

    @media (max-width: 640px) {
      .chart-container { height: 300px; }
    }

    .mode-toggle {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      background: #f1f5f9;
      padding: 0.5rem;
      border-radius: 8px;
    }

    .mode-btn {
      flex: 1;
      padding: 0.625rem 1rem;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mode-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .mode-btn:hover:not(.active) {
      background: rgba(0,0,0,0.05);
    }

    .export-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .export-btn {
      flex: 1;
      min-width: 150px;
      padding: 0.625rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: white;
      color: var(--text);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .export-btn:hover {
      background: var(--bg);
      border-color: var(--primary);
      color: var(--primary);
    }

    .export-btn svg {
      width: 16px;
      height: 16px;
    }

    @media print {
      .export-actions, .mode-toggle, .btn, .card > h2 svg, nav, header .subtitle {
        display: none !important;
      }

      body {
        background: white;
      }

      .card {
        box-shadow: none;
        border: 1px solid #e2e8f0;
        page-break-inside: avoid;
      }

      .chart-container {
        page-break-inside: avoid;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>IRS Rule 72(t) SEPP Calculator</h1>
      <p class="subtitle">Calculate Substantially Equal Periodic Payments for penalty-free early IRA withdrawals</p>
    </header>

    <div class="card">
      <div class="mode-toggle">
        <button class="mode-btn active" id="forwardModeBtn" onclick="switchMode('forward')">
          Calculate Payment from Balance
        </button>
        <button class="mode-btn" id="reverseModeBtn" onclick="switchMode('reverse')">
          Calculate Balance from Target Income
        </button>
      </div>

      <div id="forwardCalculator">
        <h2 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
          </svg>
          Enter Your Information
        </h2>

        <div class="rate-info">
        <strong>Interest Rate Note:</strong>
        Per <a href="https://www.irs.gov/pub/irs-drop/n-22-06.pdf" target="_blank" rel="noopener">IRS Notice 2022-6</a>,
        you may use any rate <strong>up to</strong> the greater of 5% or 120% of the federal mid-term rate.
        You can choose a <strong>lower</strong> rate (including 0%) for more conservative distributions.
        Higher rates produce higher payments.
      </div>

      <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 0.875rem; margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
          <div style="flex: 1; min-width: 200px;">
            <div style="font-size: 0.75rem; font-weight: 600; color: #1e40af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Current Federal Mid-Term AFR</div>
            <div style="display: flex; align-items: baseline; gap: 0.5rem;">
              <input type="number" id="currentAFR" min="0" max="10" step="0.01" value="4.24"
                style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid #bfdbfe; border-radius: 4px; font-size: 0.875rem;"
                oninput="updateMaxRate()" />
              <span style="font-size: 0.875rem; color: #64748b;">%</span>
            </div>
            <div style="font-size: 0.6875rem; color: #64748b; margin-top: 0.25rem;">
              <a href="https://www.irs.gov/applicable-federal-rates" target="_blank" rel="noopener" style="color: #3b82f6;">Update from IRS.gov</a>
            </div>
          </div>
          <div style="flex: 1; min-width: 200px;">
            <div style="font-size: 0.75rem; font-weight: 600; color: #1e40af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Maximum Allowed Rate</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #059669;" id="maxAllowedRate">5.09%</div>
            <div style="font-size: 0.6875rem; color: #64748b; margin-top: 0.25rem;">Greater of 5% or 120% of AFR</div>
          </div>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="birthdate">Date of Birth</label>
          <input type="date" id="birthdate" required />
        </div>

        <div class="form-group">
          <label for="startDate">SEPP Start Date</label>
          <input type="date" id="startDate" required />
          <span class="help-text">When distributions will begin</span>
        </div>

        <div class="form-group">
          <label for="balance">IRA Account Balance ($)</label>
          <input type="number" id="balance" min="1" step="0.01" placeholder="500000" required />
        </div>

        <div class="form-group">
          <label for="interestRate">Interest Rate (%)</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="number" id="interestRate" min="0" max="10" step="0.01" value="5.00" style="flex: 1;" />
            <button type="button" onclick="useMaxRate()"
              style="padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: white; color: var(--primary); font-size: 0.75rem; cursor: pointer; white-space: nowrap;"
              title="Use maximum allowed rate">
              Use Max
            </button>
          </div>
          <span class="help-text">0% to <span id="maxRateHelper">5.09</span>% (higher = higher payments)</span>
        </div>

        <div class="form-group">
          <label for="lifeExpTable">Life Expectancy Table</label>
          <select id="lifeExpTable">
            <option value="single" selected>Single Life Table</option>
            <option value="uniform">Uniform Lifetime Table (72+)</option>
          </select>
          <span class="help-text">Single Life typically yields higher payments</span>
        </div>

        <div class="form-group">
          <label for="growthRate">Expected Annual Growth Rate (%)</label>
          <input type="number" id="growthRate" min="-10" max="15" step="0.1" value="3.5" />
          <span class="help-text">For account balance projection chart</span>
        </div>

        <div class="form-group">
          <label for="filingStatus">Tax Filing Status</label>
          <select id="filingStatus">
            <option value="single">Single</option>
            <option value="married" selected>Married Filing Jointly</option>
          </select>
          <span class="help-text">For federal tax estimation</span>
        </div>

        <div class="form-group">
          <label for="otherIncome">Other Annual Income ($)</label>
          <input type="number" id="otherIncome" min="0" step="1000" value="0" />
          <span class="help-text">Non-SEPP income (wages, SS, etc.)</span>
        </div>

        <div class="form-group">
          <label for="stateSelect">State (for tax estimation)</label>
          <select id="stateSelect">
            <option value="none">No State Tax</option>
          </select>
          <span class="help-text">Optional state income tax</span>
        </div>
      </div>

        <button class="btn" onclick="calculate()">Calculate SEPP Amounts</button>
        <div id="tableNote" class="inline-note hidden"></div>
      </div>

      <div id="reverseCalculator" class="hidden">
        <h2 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
          </svg>
          Target Income Calculator
        </h2>

        <div class="rate-info">
          <strong>Planning Tool:</strong>
          Enter your desired annual income to see the required IRA balance needed for each SEPP method.
          This helps you plan before committing to a 72(t) distribution strategy.
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="reverseBirthdate">Date of Birth</label>
            <input type="date" id="reverseBirthdate" required />
          </div>

          <div class="form-group">
            <label for="reverseStartDate">SEPP Start Date</label>
            <input type="date" id="reverseStartDate" required />
            <span class="help-text">When distributions will begin</span>
          </div>

          <div class="form-group">
            <label for="targetIncome">Target Annual Income ($)</label>
            <input type="number" id="targetIncome" min="1" step="1" placeholder="100000" required />
            <span class="help-text">Desired annual distribution amount</span>
          </div>

          <div class="form-group">
            <label for="reverseInterestRate">Interest Rate (%)</label>
            <input type="number" id="reverseInterestRate" min="0" max="10" step="0.01" value="5.00" />
            <span class="help-text">Max is IRS-limited (Notice 2022-6)</span>
          </div>

          <div class="form-group">
            <label for="reverseLifeExpTable">Life Expectancy Table</label>
            <select id="reverseLifeExpTable">
              <option value="single" selected>Single Life Table</option>
              <option value="uniform">Uniform Lifetime Table (72+)</option>
            </select>
            <span class="help-text">Single Life typically yields higher payments</span>
          </div>
        </div>

        <button class="btn" onclick="calculateReverse()">Calculate Required Balance</button>
        <div id="reverseTableNote" class="inline-note hidden"></div>
      </div>
    </div>

    <div id="reverseResults" class="card hidden">
      <h2 class="card-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" />
          <polyline points="16 7 22 7 22 13" />
        </svg>
        Required Account Balances
      </h2>

      <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">
        To achieve your target annual income of <strong id="reverseTargetDisplay">$0</strong>, you would need the following IRA balances:
      </p>

      <div class="results-grid">
        <div class="result-card rmd">
          <div class="result-method">RMD Method</div>
          <div class="result-amount" id="reverseRmdBalance">$0</div>
          <div class="result-monthly" style="font-size: 0.75rem; opacity: 0.85;">Required Balance</div>
        </div>

        <div class="result-card amortization">
          <div class="result-method">Amortization Method</div>
          <div class="result-amount" id="reverseAmortBalance">$0</div>
          <div class="result-monthly" style="font-size: 0.75rem; opacity: 0.85;">Required Balance</div>
        </div>

        <div class="result-card annuitization">
          <div class="result-method">Annuitization Method</div>
          <div class="result-amount" id="reverseAnnuitBalance">$0</div>
          <div class="result-monthly" style="font-size: 0.75rem; opacity: 0.85;">Required Balance</div>
        </div>
      </div>

      <div class="info-section">
        <h3 style="font-size: 0.9375rem; margin-bottom: 0.5rem;">Calculation Details</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Your Age at Start</span>
            <span class="info-value" id="reverseCalcAge">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Life Expectancy / Divisor</span>
            <span class="info-value" id="reverseCalcLifeExp">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Interest Rate Used</span>
            <span class="info-value" id="reverseCalcRate">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Target Annual Income</span>
            <span class="info-value" id="reverseCalcIncome">-</span>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h3 style="font-size: 0.9375rem; margin-bottom: 0.5rem;">Reverse Calculation Formulas</h3>
        <div id="reverseCalcBreakdown" style="font-size: 0.8125rem; line-height: 1.8; color: var(--text-muted);"></div>
      </div>

      <div class="warning-box">
        <h4>üí° Planning Tip</h4>
        <p>These are the <strong>starting balances</strong> needed to generate your target income. The RMD method requires the smallest balance but payments decrease over time. Fixed methods (Amortization/Annuitization) require larger balances but provide consistent payments.</p>
      </div>
    </div>

    <div id="results" class="card hidden">
      <h2 class="card-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" />
          <polyline points="16 7 22 7 22 13" />
        </svg>
        Your 72(t) Distribution Options
      </h2>

      <div style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 1rem;">
        Calculated on: <span id="calculationTimestamp">-</span>
      </div>

      <div class="export-actions">
        <button class="export-btn" onclick="printResults()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
          </svg>
          Print / Save PDF
        </button>
        <button class="export-btn" onclick="copyShareableLink()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
          </svg>
          Copy Shareable Link
        </button>
        <button class="export-btn" onclick="saveScenario()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
          </svg>
          Save Scenario
        </button>
      </div>

      <div class="results-grid">
        <div class="result-card rmd">
          <div class="result-method">RMD Method</div>
          <div class="result-amount" id="rmdAmount">$0</div>
          <div class="result-monthly" id="rmdMonthly">$0/month</div>
        </div>

        <div class="result-card amortization">
          <div class="result-method">Amortization Method</div>
          <div class="result-amount" id="amortAmount">$0</div>
          <div class="result-monthly" id="amortMonthly">$0/month</div>
        </div>

        <div class="result-card annuitization">
          <div class="result-method">Annuitization Method</div>
          <div class="result-amount" id="annuitAmount">$0</div>
          <div class="result-monthly" id="annuitMonthly">$0/month</div>
        </div>
      </div>

      <div class="sepp-duration">
        <h4>Required SEPP Duration</h4>
        <div class="duration" id="seppDuration">-</div>
        <div class="help-text" id="seppEndDate">-</div>
      </div>

      <div id="taxImpactSection" class="info-section" style="display: none;">
        <h3 style="font-size: 0.9375rem; margin-bottom: 0.75rem;">After-Tax Income Estimates</h3>
        <p style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 0.75rem;">
          Based on <span id="taxFilingStatusDisplay">-</span> filing status and <span id="taxStateDisplay">-</span> state tax.
        </p>

        <div class="results-grid" style="margin-top: 0.75rem;">
          <div style="background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 8px; padding: 1rem; text-align: center;">
            <div style="font-size: 0.75rem; text-transform: uppercase; color: #065f46; letter-spacing: 0.05em; margin-bottom: 0.25rem;">RMD After-Tax</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #059669;" id="rmdAfterTax">$0</div>
            <div style="font-size: 0.75rem; color: #065f46; margin-top: 0.25rem;" id="rmdAfterTaxMonthly">$0/month</div>
          </div>

          <div style="background: #faf5ff; border: 1px solid #e9d5ff; border-radius: 8px; padding: 1rem; text-align: center;">
            <div style="font-size: 0.75rem; text-transform: uppercase; color: #6b21a8; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Amortization After-Tax</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #7c3aed;" id="amortAfterTax">$0</div>
            <div style="font-size: 0.75rem; color: #6b21a8; margin-top: 0.25rem;" id="amortAfterTaxMonthly">$0/month</div>
          </div>

          <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; text-align: center;">
            <div style="font-size: 0.75rem; text-transform: uppercase; color: #991b1b; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Annuitization After-Tax</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #dc2626;" id="annuitAfterTax">$0</div>
            <div style="font-size: 0.75rem; color: #991b1b; margin-top: 0.25rem;" id="annuitAfterTaxMonthly">$0/month</div>
          </div>
        </div>

        <div style="margin-top: 1rem; font-size: 0.8125rem; color: var(--text-muted);">
          <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed var(--border);">
            <span>Effective Tax Rate:</span>
            <span id="effectiveTaxRate" style="font-weight: 600;">-</span>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h3 style="font-size: 0.9375rem; margin-bottom: 0.5rem;">Calculation Details</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Your Age at Start</span>
            <span class="info-value" id="calcAge">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Life Expectancy / Divisor</span>
            <span class="info-value" id="calcLifeExp">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Interest Rate Used</span>
            <span class="info-value" id="calcRate">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Account Balance</span>
            <span class="info-value" id="calcBalance">-</span>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h3 style="font-size: 0.9375rem; margin-bottom: 0.5rem;">Calculation Breakdown</h3>
        <div id="calcBreakdown" style="font-size: 0.8125rem; line-height: 1.8; color: var(--text-muted);"></div>
      </div>

      <div class="info-section">
        <h3 style="font-size: 0.9375rem; margin-bottom: 0.5rem;">Account Balance Projection</h3>
        <p id="chartDescription" style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 1rem;">
          This chart shows how your account balance will change over the SEPP duration for each method.
          If your account depletes, the line will reach $0.
        </p>
        <div class="chart-container">
          <canvas id="balanceChart"></canvas>
        </div>
      </div>

      <div class="method-descriptions">
        <div class="method-desc">
          <h5>RMD Method (Recalculated Annually)</h5>
          <p><strong>Formula:</strong> Annual Payment = Account Balance √∑ Life Expectancy Divisor</p>
          <p>Recalculated each year based on current account value and updated divisor from IRS life expectancy tables. Generally produces the <strong>lowest</strong> payment. Amount varies annually.</p>
          <p><strong>Source:</strong> <a href="https://www.irs.gov/pub/irs-drop/n-22-06.pdf" target="_blank" rel="noopener">IRS Notice 2022-6</a>, <a href="https://www.ecfr.gov/current/title-26/section-1.401(a)(9)-9" target="_blank" rel="noopener">26 CFR ¬ß1.401(a)(9)-9</a></p>
        </div>
        <div class="method-desc">
          <h5>Fixed Amortization Method</h5>
          <p><strong>Formula:</strong> Annual Payment = Account Balance √∑ PV Factor</p>
          <p>Where PV Factor = (1 - (1+r)<sup>-n</sup>) / r</p>
          <p>Uses life expectancy (n years) and interest rate (r) to compute a level annual payment. <strong>Fixed payment</strong> each year.</p>
          <p><strong>Source:</strong> <a href="https://www.irs.gov/pub/irs-drop/n-22-06.pdf" target="_blank" rel="noopener">IRS Notice 2022-6</a></p>
        </div>
        <div class="method-desc">
          <h5>Fixed Annuitization Method</h5>
          <p><strong>Formula:</strong> Annual Payment = Account Balance √∑ Annuity Factor</p>
          <p>Where Annuity Factor = Œ£ [Survival Probability √ó (1+r)<sup>-t</sup>]</p>
          <p>Uses an annuity factor derived from IRS mortality rates (<a href="https://www.ecfr.gov/current/title-26/section-1.401(a)(9)-9" target="_blank" rel="noopener">26 CFR ¬ß1.401(a)(9)-9(e), Table 4</a>) and the chosen interest rate. <strong>Fixed payment</strong> each year.</p>
          <p><strong>Source:</strong> <a href="https://www.irs.gov/pub/irs-drop/n-22-06.pdf" target="_blank" rel="noopener">IRS Notice 2022-6</a>, <a href="https://www.ecfr.gov/current/title-26/section-1.401(a)(9)-9" target="_blank" rel="noopener">26 CFR ¬ß1.401(a)(9)-9</a></p>
        </div>
      </div>

      <div class="warning-box">
        <h4>‚ö†Ô∏è Important 72(t) Rules</h4>
        <p>Once started, SEPP payments must continue for <strong>5 years OR until age 59¬Ω</strong>, whichever is <strong>longer</strong>. Modifying payments before this period ends triggers a 10% penalty plus interest on ALL prior distributions. You may make a <strong>one-time switch</strong> from Amortization or Annuitization to the RMD method without penalty.</p>
      </div>

      <div class="disclaimer">
        <strong>Disclaimer:</strong> Informational only. Consult a qualified tax professional before implementing any 72(t) plan. Verify current IRS rules and AFR limits on IRS.gov.
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">About IRS Rule 72(t)</h2>
      <p style="font-size: 0.875rem; color: var(--text-muted); line-height: 1.7;">
        Section 72(t) allows penalty-free early withdrawals from IRAs and qualified plans before age 59¬Ω through SEPP.
        The IRS provides three approved calculation methods: RMD, Fixed Amortization, and Fixed Annuitization.
      </p>
    </div>

    <div class="card">
      <h2 class="card-title">IRS References & Documentation</h2>
      <div style="font-size: 0.875rem; line-height: 1.8;">
        <p style="margin-bottom: 0.75rem;"><strong>Primary Guidance:</strong></p>
        <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
          <li><a href="https://www.irs.gov/pub/irs-drop/n-22-06.pdf" target="_blank" rel="noopener">IRS Notice 2022-6</a> - Current guidance on SEPP calculations (supersedes Rev. Rul. 2002-62)</li>
          <li><a href="https://www.irs.gov/pub/irs-drop/rr-02-62.pdf" target="_blank" rel="noopener">Revenue Ruling 2002-62</a> - Original SEPP calculation guidance (historical reference)</li>
          <li><a href="https://www.irs.gov/retirement-plans/substantially-equal-periodic-payments" target="_blank" rel="noopener">IRS SEPP Overview</a> - General information on 72(t) distributions</li>
        </ul>
        <p style="margin-bottom: 0.75rem;"><strong>Life Expectancy & Mortality Tables:</strong></p>
        <ul style="margin-left: 1.5rem; margin-bottom: 1rem;">
          <li><a href="https://www.ecfr.gov/current/title-26/section-1.401(a)(9)-9" target="_blank" rel="noopener">26 CFR ¬ß1.401(a)(9)-9</a> - Life expectancy and distribution period tables
            <ul style="margin-left: 1.5rem; margin-top: 0.25rem;">
              <li>Table 1 (Single Life Table) - ¬ß1.401(a)(9)-9(b)</li>
              <li>Table 2 (Uniform Lifetime Table) - ¬ß1.401(a)(9)-9(c)</li>
              <li>Table 4 (Mortality Rates) - ¬ß1.401(a)(9)-9(e)</li>
            </ul>
          </li>
          <li><a href="https://apps.irs.gov/app/picklist/list/federalRates.html" target="_blank" rel="noopener">IRS Applicable Federal Rates (AFR)</a> - Current federal mid-term rates</li>
        </ul>
        <p style="margin-bottom: 0.75rem;"><strong>Interest Rate Rules:</strong></p>
        <ul style="margin-left: 1.5rem;">
          <li>Per Notice 2022-6: Use the <strong>greater of 5% or 120% of the federal mid-term rate</strong> for amortization and annuitization methods</li>
          <li>This 5% floor represents a significant increase from prior guidance and allows for higher distribution amounts</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // Table 1 (Single Life Table) from 26 CFR ¬ß1.401(a)(9)-9(b)
    const singleLifeTable = {
      0: 84.6, 1: 83.7, 2: 82.8, 3: 81.8, 4: 80.8, 5: 79.8, 6: 78.8, 7: 77.9, 8: 76.9, 9: 75.9,
      10: 74.9, 11: 73.9, 12: 72.9, 13: 71.9, 14: 70.9, 15: 69.9, 16: 69.0, 17: 68.0, 18: 67.0, 19: 66.0,
      20: 65.0, 21: 64.1, 22: 63.1, 23: 62.1, 24: 61.1, 25: 60.2, 26: 59.2, 27: 58.2, 28: 57.3, 29: 56.3,
      30: 55.3, 31: 54.4, 32: 53.4, 33: 52.5, 34: 51.5, 35: 50.5, 36: 49.6, 37: 48.6, 38: 47.7, 39: 46.7,
      40: 45.7, 41: 44.8, 42: 43.8, 43: 42.9, 44: 41.9, 45: 41.0, 46: 40.0, 47: 39.0, 48: 38.1, 49: 37.1,
      50: 36.2, 51: 35.3, 52: 34.3, 53: 33.4, 54: 32.5, 55: 31.6, 56: 30.6, 57: 29.8, 58: 28.9, 59: 28.0,
      60: 27.1, 61: 26.2, 62: 25.4, 63: 24.5, 64: 23.7, 65: 22.9, 66: 22.0, 67: 21.2, 68: 20.4, 69: 19.6,
      70: 18.8, 71: 18.0, 72: 17.2, 73: 16.4, 74: 15.6, 75: 14.8, 76: 14.1, 77: 13.3, 78: 12.6, 79: 11.9,
      80: 11.2, 81: 10.5, 82: 9.9, 83: 9.3, 84: 8.7, 85: 8.1, 86: 7.6, 87: 7.1, 88: 6.6, 89: 6.1,
      90: 5.7, 91: 5.3, 92: 4.9, 93: 4.6, 94: 4.3, 95: 4.0, 96: 3.7, 97: 3.4, 98: 3.2, 99: 3.0,
      100: 2.8, 101: 2.6, 102: 2.5, 103: 2.3, 104: 2.2, 105: 2.1, 106: 2.1, 107: 2.1, 108: 2.0, 109: 2.0,
      110: 2.0, 111: 2.0, 112: 2.0, 113: 1.9, 114: 1.9, 115: 1.8, 116: 1.8, 117: 1.6, 118: 1.4, 119: 1.1,
      120: 1.0
    };

    // Table 2 (Uniform Lifetime Table) from 26 CFR ¬ß1.401(a)(9)-9(c) ‚Äî starts at age 72
    const uniformLifetimeTable = {
      72: 27.4, 73: 26.5, 74: 25.5, 75: 24.6, 76: 23.7, 77: 22.9, 78: 22.0, 79: 21.1,
      80: 20.2, 81: 19.4, 82: 18.5, 83: 17.7, 84: 16.8, 85: 16.0, 86: 15.2, 87: 14.4,
      88: 13.7, 89: 12.9, 90: 12.2, 91: 11.5, 92: 10.8, 93: 10.1, 94: 9.5, 95: 8.9,
      96: 8.4, 97: 7.8, 98: 7.3, 99: 6.8, 100: 6.4, 101: 6.0, 102: 5.6, 103: 5.2,
      104: 4.9, 105: 4.6, 106: 4.3, 107: 4.1, 108: 3.9, 109: 3.7, 110: 3.5, 111: 3.4,
      112: 3.3, 113: 3.1, 114: 3.0, 115: 2.9, 116: 2.8, 117: 2.7, 118: 2.5, 119: 2.3,
      120: 2.0
    };

    // Table 4 (Mortality Rates) from 26 CFR ¬ß1.401(a)(9)-9(e)
    // qx = probability of death between exact age x and x+1
    const mortalityQx = {
      0: 0.001762, 1: 0.000441, 2: 0.000292, 3: 0.000232, 4: 0.000177, 5: 0.000161, 6: 0.000153, 7: 0.000145, 8: 0.000132, 9: 0.000127,
      10: 0.000128, 11: 0.000135, 12: 0.000146, 13: 0.000164, 14: 0.000192, 15: 0.000223, 16: 0.000253, 17: 0.000276, 18: 0.000293, 19: 0.000304,
      20: 0.000313, 21: 0.000343, 22: 0.000377, 23: 0.000421, 24: 0.000466, 25: 0.000520, 26: 0.000581, 27: 0.000630, 28: 0.000677, 29: 0.000720,
      30: 0.000763, 31: 0.000799, 32: 0.000824, 33: 0.000833, 34: 0.000830, 35: 0.000823, 36: 0.000819, 37: 0.000824, 38: 0.000836, 39: 0.000853,
      40: 0.000879, 41: 0.000909, 42: 0.000945, 43: 0.000980, 44: 0.001019, 45: 0.001065, 46: 0.001132, 47: 0.001225, 48: 0.001345, 49: 0.001485,
      50: 0.001656, 51: 0.001874, 52: 0.002121, 53: 0.002397, 54: 0.002701, 55: 0.003032, 56: 0.003390, 57: 0.003774, 58: 0.004181, 59: 0.004613,
      60: 0.005071, 61: 0.005554, 62: 0.006071, 63: 0.006624, 64: 0.007225, 65: 0.007884, 66: 0.008238, 67: 0.008659, 68: 0.009163, 69: 0.009767,
      70: 0.010491, 71: 0.011358, 72: 0.012385, 73: 0.013598, 74: 0.015014, 75: 0.016670, 76: 0.018587, 77: 0.020815, 78: 0.023391, 79: 0.026387,
      80: 0.029850, 81: 0.033883, 82: 0.038544, 83: 0.043880, 84: 0.049956, 85: 0.056799, 86: 0.064436, 87: 0.072882, 88: 0.082137, 89: 0.092172,
      90: 0.102919, 91: 0.114344, 92: 0.126605, 93: 0.139936, 94: 0.154844, 95: 0.171902, 96: 0.187210, 97: 0.204659, 98: 0.222921, 99: 0.241884,
      100: 0.261476, 101: 0.281536, 102: 0.301847, 103: 0.322371, 104: 0.342940, 105: 0.361261, 106: 0.372886, 107: 0.381098, 108: 0.383358, 109: 0.385709,
      110: 0.388092, 111: 0.390353, 112: 0.392822, 113: 0.395188, 114: 0.397567, 115: 0.400000, 116: 0.400000, 117: 0.400000, 118: 0.400000, 119: 0.400000,
      120: 0.400000
    };

    // 2025 Federal Tax Brackets (Single filer)
    const federalTaxBracketsSingle = [
      { min: 0, max: 11925, rate: 0.10 },
      { min: 11925, max: 48475, rate: 0.12 },
      { min: 48475, max: 103350, rate: 0.22 },
      { min: 103350, max: 197300, rate: 0.24 },
      { min: 197300, max: 250525, rate: 0.32 },
      { min: 250525, max: 626350, rate: 0.35 },
      { min: 626350, max: Infinity, rate: 0.37 }
    ];

    // 2025 Federal Tax Brackets (Married filing jointly)
    const federalTaxBracketsMarried = [
      { min: 0, max: 23850, rate: 0.10 },
      { min: 23850, max: 96950, rate: 0.12 },
      { min: 96950, max: 206700, rate: 0.22 },
      { min: 206700, max: 394600, rate: 0.24 },
      { min: 394600, max: 501050, rate: 0.32 },
      { min: 501050, max: 751600, rate: 0.35 },
      { min: 751600, max: Infinity, rate: 0.37 }
    ];

    // State tax rates (flat rates for simplicity, 2024-2025 estimates)
    const stateTaxRates = {
      "none": { name: "No State Tax", rate: 0 },
      "AL": { name: "Alabama", rate: 0.05 },
      "AK": { name: "Alaska", rate: 0 },
      "AZ": { name: "Arizona", rate: 0.025 },
      "AR": { name: "Arkansas", rate: 0.044 },
      "CA": { name: "California", rate: 0.093 },
      "CO": { name: "Colorado", rate: 0.044 },
      "CT": { name: "Connecticut", rate: 0.0699 },
      "DE": { name: "Delaware", rate: 0.066 },
      "FL": { name: "Florida", rate: 0 },
      "GA": { name: "Georgia", rate: 0.0575 },
      "HI": { name: "Hawaii", rate: 0.11 },
      "ID": { name: "Idaho", rate: 0.058 },
      "IL": { name: "Illinois", rate: 0.0495 },
      "IN": { name: "Indiana", rate: 0.0315 },
      "IA": { name: "Iowa", rate: 0.053 },
      "KS": { name: "Kansas", rate: 0.057 },
      "KY": { name: "Kentucky", rate: 0.04 },
      "LA": { name: "Louisiana", rate: 0.0425 },
      "ME": { name: "Maine", rate: 0.0715 },
      "MD": { name: "Maryland", rate: 0.0575 },
      "MA": { name: "Massachusetts", rate: 0.05 },
      "MI": { name: "Michigan", rate: 0.0425 },
      "MN": { name: "Minnesota", rate: 0.0985 },
      "MS": { name: "Mississippi", rate: 0.05 },
      "MO": { name: "Missouri", rate: 0.048 },
      "MT": { name: "Montana", rate: 0.0675 },
      "NE": { name: "Nebraska", rate: 0.0684 },
      "NV": { name: "Nevada", rate: 0 },
      "NH": { name: "New Hampshire", rate: 0 },
      "NJ": { name: "New Jersey", rate: 0.1075 },
      "NM": { name: "New Mexico", rate: 0.059 },
      "NY": { name: "New York", rate: 0.109 },
      "NC": { name: "North Carolina", rate: 0.0475 },
      "ND": { name: "North Dakota", rate: 0.029 },
      "OH": { name: "Ohio", rate: 0.0385 },
      "OK": { name: "Oklahoma", rate: 0.0475 },
      "OR": { name: "Oregon", rate: 0.099 },
      "PA": { name: "Pennsylvania", rate: 0.0307 },
      "RI": { name: "Rhode Island", rate: 0.0599 },
      "SC": { name: "South Carolina", rate: 0.065 },
      "SD": { name: "South Dakota", rate: 0 },
      "TN": { name: "Tennessee", rate: 0 },
      "TX": { name: "Texas", rate: 0 },
      "UT": { name: "Utah", rate: 0.0465 },
      "VT": { name: "Vermont", rate: 0.0875 },
      "VA": { name: "Virginia", rate: 0.0575 },
      "WA": { name: "Washington", rate: 0 },
      "WV": { name: "West Virginia", rate: 0.065 },
      "WI": { name: "Wisconsin", rate: 0.0765 },
      "WY": { name: "Wyoming", rate: 0 }
    };

    // Defaults
    document.addEventListener("DOMContentLoaded", function () {
      const today = new Date();
      document.getElementById("startDate").value = today.toISOString().split("T")[0];
      document.getElementById("reverseStartDate").value = today.toISOString().split("T")[0];

      // Default birthdate to 55 years ago
      const defaultBirth = new Date(today.getFullYear() - 55, today.getMonth(), today.getDate());
      document.getElementById("birthdate").value = defaultBirth.toISOString().split("T")[0];
      document.getElementById("reverseBirthdate").value = defaultBirth.toISOString().split("T")[0];

      // Populate state dropdown
      const stateSelect = document.getElementById("stateSelect");
      Object.keys(stateTaxRates).forEach(key => {
        if (key !== 'none') {
          const option = document.createElement("option");
          option.value = key;
          option.textContent = stateTaxRates[key].name;
          stateSelect.appendChild(option);
        }
      });

      // Load from URL if parameters present
      loadFromUrl();
    });

    // Update maximum allowed rate based on AFR
    function updateMaxRate() {
      const afr = parseFloat(document.getElementById('currentAFR').value) || 0;
      const afrTimes120 = afr * 1.20;
      const maxRate = Math.max(5.0, afrTimes120);
      document.getElementById('maxAllowedRate').textContent = maxRate.toFixed(2) + '%';

      // Update interest rate field max attribute and helper text
      document.getElementById('interestRate').max = maxRate.toFixed(2);
      document.getElementById('maxRateHelper').textContent = maxRate.toFixed(2);
    }

    // Use max allowed rate
    function useMaxRate() {
      const maxRate = document.getElementById('maxAllowedRate').textContent.replace('%', '');
      document.getElementById('interestRate').value = maxRate;
    }

    // Mode switching
    function switchMode(mode) {
      if (mode === 'forward') {
        document.getElementById('forwardCalculator').classList.remove('hidden');
        document.getElementById('reverseCalculator').classList.add('hidden');
        document.getElementById('results').classList.add('hidden');
        document.getElementById('reverseResults').classList.add('hidden');
        document.getElementById('forwardModeBtn').classList.add('active');
        document.getElementById('reverseModeBtn').classList.remove('active');
      } else {
        document.getElementById('forwardCalculator').classList.add('hidden');
        document.getElementById('reverseCalculator').classList.remove('hidden');
        document.getElementById('results').classList.add('hidden');
        document.getElementById('reverseResults').classList.add('hidden');
        document.getElementById('forwardModeBtn').classList.remove('active');
        document.getElementById('reverseModeBtn').classList.add('active');
      }
    }

    // Print results
    function printResults() {
      window.print();
    }

    // Copy shareable link with parameters
    function copyShareableLink() {
      const params = new URLSearchParams({
        birthdate: document.getElementById('birthdate').value,
        startDate: document.getElementById('startDate').value,
        balance: document.getElementById('balance').value,
        interestRate: document.getElementById('interestRate').value,
        growthRate: document.getElementById('growthRate').value,
        filingStatus: document.getElementById('filingStatus').value,
        otherIncome: document.getElementById('otherIncome').value,
        state: document.getElementById('stateSelect').value,
        table: document.getElementById('lifeExpTable').value
      });

      const shareableUrl = window.location.origin + window.location.pathname + '?' + params.toString();

      // Copy to clipboard
      navigator.clipboard.writeText(shareableUrl).then(() => {
        alert('Shareable link copied to clipboard!\n\nAnyone with this link can view your calculation with the same parameters.');
      }).catch(() => {
        // Fallback for older browsers
        prompt('Copy this link to share your calculation:', shareableUrl);
      });
    }

    // Save scenario to localStorage
    function saveScenario() {
      const scenarioName = prompt('Enter a name for this scenario:', 'SEPP Calculation ' + new Date().toLocaleDateString());
      if (!scenarioName) return;

      const scenario = {
        name: scenarioName,
        timestamp: new Date().toISOString(),
        params: {
          birthdate: document.getElementById('birthdate').value,
          startDate: document.getElementById('startDate').value,
          balance: document.getElementById('balance').value,
          interestRate: document.getElementById('interestRate').value,
          growthRate: document.getElementById('growthRate').value,
          filingStatus: document.getElementById('filingStatus').value,
          otherIncome: document.getElementById('otherIncome').value,
          state: document.getElementById('stateSelect').value,
          table: document.getElementById('lifeExpTable').value
        },
        results: {
          rmdAmount: document.getElementById('rmdAmount').textContent,
          amortAmount: document.getElementById('amortAmount').textContent,
          annuitAmount: document.getElementById('annuitAmount').textContent
        }
      };

      // Get existing scenarios
      const scenarios = JSON.parse(localStorage.getItem('seppScenarios') || '[]');
      scenarios.push(scenario);
      localStorage.setItem('seppScenarios', JSON.stringify(scenarios));

      alert('Scenario saved! You can load it later from the browser on this device.');
    }

    // Load parameters from URL on page load
    function loadFromUrl() {
      const params = new URLSearchParams(window.location.search);
      if (params.has('birthdate')) {
        document.getElementById('birthdate').value = params.get('birthdate');
        document.getElementById('startDate').value = params.get('startDate');
        document.getElementById('balance').value = params.get('balance');
        document.getElementById('interestRate').value = params.get('interestRate') || '5.00';
        document.getElementById('growthRate').value = params.get('growthRate') || '3.5';
        document.getElementById('filingStatus').value = params.get('filingStatus') || 'married';
        document.getElementById('otherIncome').value = params.get('otherIncome') || '0';
        document.getElementById('stateSelect').value = params.get('state') || 'none';
        document.getElementById('lifeExpTable').value = params.get('table') || 'single';

        // Auto-calculate if URL has parameters
        setTimeout(() => calculate(), 100);
      }
    }

    function calculateAge(birthdate, targetDate) {
      if (!birthdate || !targetDate) return 0;
      const birth = new Date(birthdate + "T00:00:00");
      const target = new Date(targetDate + "T00:00:00");
      if (isNaN(birth.getTime()) || isNaN(target.getTime())) return 0;

      let age = target.getFullYear() - birth.getFullYear();
      const monthDiff = target.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && target.getDate() < birth.getDate())) age--;
      return Math.max(0, age);
    }

    function getDivisorOrLifeExpectancy(age, tableType) {
      const a = Math.max(0, Math.min(120, Math.floor(age)));

      if (tableType === "single") {
        return singleLifeTable[a] ?? singleLifeTable[120];
      }

      // Uniform Lifetime Table is defined (in CFR Table 2) starting at age 72.
      if (tableType === "uniform") {
        return uniformLifetimeTable[a] ?? null;
      }

      return singleLifeTable[a] ?? singleLifeTable[120];
    }

    // RMD Method: Balance / Divisor
    function calculateRMD(balance, divisor) {
      if (!divisor || divisor <= 0) return 0;
      return balance / divisor;
    }

    // Amortization Method: Level payment over "n" years at rate r
    // PV factor = (1 - (1+r)^-n) / r
    function calculateAmortization(balance, n, annualRatePct) {
      const r = annualRatePct / 100;
      if (n <= 0) return 0;
      if (r === 0) return balance / n;
      const pvFactor = (1 - Math.pow(1 + r, -n)) / r;
      return balance / pvFactor;
    }

    // Annuitization Method: balance / annuity factor
    // annuity factor = sum_{t=1..} [Pr(alive at end of year t) / (1+r)^t]
    // Uses CFR Table 4 mortality rates (qx).
    function calculateAnnuitization(balance, age, annualRatePct) {
      const r = annualRatePct / 100;
      const startAge = Math.max(0, Math.min(120, Math.floor(age)));

      if (balance <= 0) return 0;

      let survival = 1.0;
      let annuityFactor = 0.0;

      // iterate yearly payments; cap to avoid infinite loops
      for (let t = 1; t <= 200; t++) {
        const currentAge = startAge + (t - 1);
        if (currentAge > 120) break;

        const qx = mortalityQx[currentAge];
        if (typeof qx !== "number") break;

        // survive through this year to be alive at end of year t
        survival *= (1 - qx);

        const pv = r > 0 ? Math.pow(1 + r, -t) : 1.0;
        annuityFactor += survival * pv;

        if (survival < 1e-10) break;
      }

      if (!(annuityFactor > 0) || !isFinite(annuityFactor)) return 0;
      return balance / annuityFactor;
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    }

    // Calculate federal income tax using progressive brackets
    function calculateFederalTax(taxableIncome, filingStatus) {
      const brackets = filingStatus === 'married' ? federalTaxBracketsMarried : federalTaxBracketsSingle;
      let tax = 0;
      let previousMax = 0;

      for (const bracket of brackets) {
        if (taxableIncome <= bracket.min) break;

        const taxableInBracket = Math.min(taxableIncome, bracket.max) - bracket.min;
        tax += taxableInBracket * bracket.rate;

        if (taxableIncome <= bracket.max) break;
      }

      return tax;
    }

    // Calculate total tax burden and after-tax income
    function calculateTaxes(seppIncome, otherIncome, filingStatus, stateCode) {
      const totalIncome = seppIncome + otherIncome;

      // Calculate federal tax
      const federalTax = calculateFederalTax(totalIncome, filingStatus);

      // Calculate state tax (simplified as flat rate)
      const stateTaxRate = stateTaxRates[stateCode]?.rate || 0;
      const stateTax = totalIncome * stateTaxRate;

      // Total tax and after-tax income
      const totalTax = federalTax + stateTax;
      const afterTaxIncome = seppIncome - (totalTax * (seppIncome / totalIncome)); // Proportional tax

      return {
        federalTax,
        stateTax,
        totalTax,
        afterTaxIncome,
        effectiveTaxRate: (totalTax / totalIncome) * 100
      };
    }

    // Reverse calculations: Given desired payment, calculate required balance

    // Reverse RMD: balance = payment * divisor
    function reverseCalculateRMD(annualPayment, divisor) {
      if (!divisor || divisor <= 0) return 0;
      return annualPayment * divisor;
    }

    // Reverse Amortization: balance = payment * PV factor
    function reverseCalculateAmortization(annualPayment, n, annualRatePct) {
      const r = annualRatePct / 100;
      if (n <= 0) return 0;
      if (r === 0) return annualPayment * n;
      const pvFactor = (1 - Math.pow(1 + r, -n)) / r;
      return annualPayment * pvFactor;
    }

    // Reverse Annuitization: balance = payment * annuity factor
    function reverseCalculateAnnuitization(annualPayment, age, annualRatePct) {
      const r = annualRatePct / 100;
      const startAge = Math.max(0, Math.min(120, Math.floor(age)));

      if (annualPayment <= 0) return 0;

      let survival = 1.0;
      let annuityFactor = 0.0;

      // Calculate annuity factor (same as forward calculation)
      for (let t = 1; t <= 200; t++) {
        const currentAge = startAge + (t - 1);
        if (currentAge > 120) break;

        const qx = mortalityQx[currentAge];
        if (typeof qx !== "number") break;

        survival *= (1 - qx);
        const pv = r > 0 ? Math.pow(1 + r, -t) : 1.0;
        annuityFactor += survival * pv;

        if (survival < 1e-10) break;
      }

      if (!(annuityFactor > 0) || !isFinite(annuityFactor)) return 0;
      return annualPayment * annuityFactor;
    }

    // Project account balance for RMD method
    function projectRMD(initialBalance, startAge, years, growthRate, tableType) {
      let balance = initialBalance;
      const projections = [{year: 0, balance: initialBalance}];
      let depleted = false;

      for (let year = 1; year <= years; year++) {
        if (depleted) {
          projections.push({year, balance: 0});
          continue;
        }

        const currentAge = startAge + year;
        const divisor = getDivisorOrLifeExpectancy(currentAge, tableType);

        if (!divisor || divisor <= 0) {
          projections.push({year, balance: 0});
          depleted = true;
          continue;
        }

        const distribution = balance / divisor;
        balance = (balance - distribution) * (1 + growthRate / 100);
        balance = Math.max(0, balance);
        projections.push({year, balance});

        if (balance === 0) {
          depleted = true;
        }
      }

      return projections;
    }

    // Project account balance for fixed payment methods (Amortization & Annuitization)
    function projectFixedPayment(initialBalance, annualPayment, years, growthRate) {
      let balance = initialBalance;
      const projections = [{year: 0, balance: initialBalance}];
      let depleted = false;

      for (let year = 1; year <= years; year++) {
        if (depleted) {
          projections.push({year, balance: 0});
          continue;
        }

        balance = (balance - annualPayment) * (1 + growthRate / 100);
        balance = Math.max(0, balance);
        projections.push({year, balance});

        if (balance === 0) {
          depleted = true;
        }
      }

      return projections;
    }

    // Global chart instance
    let balanceChartInstance = null;

    // Render the projection chart
    function renderBalanceChart(rmdData, amortData, annuitData) {
      const ctx = document.getElementById('balanceChart').getContext('2d');

      // Destroy existing chart if it exists
      if (balanceChartInstance) {
        balanceChartInstance.destroy();
      }

      // Find max years to display
      const maxYears = Math.max(
        rmdData[rmdData.length - 1].year,
        amortData[amortData.length - 1].year,
        annuitData[annuitData.length - 1].year
      );

      // Check if any account depletes to determine if we should start Y-axis at zero
      const allBalances = [
        ...rmdData.map(d => d.balance),
        ...amortData.map(d => d.balance),
        ...annuitData.map(d => d.balance)
      ];
      const minBalance = Math.min(...allBalances);
      const shouldBeginAtZero = minBalance === 0;

      balanceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({length: maxYears + 1}, (_, i) => i),
          datasets: [
            {
              label: 'RMD Method',
              data: rmdData.map(d => d.balance),
              borderColor: 'rgb(5, 150, 105)',
              backgroundColor: 'rgba(5, 150, 105, 0.1)',
              borderWidth: 2,
              pointRadius: 3,
              pointHoverRadius: 5,
              tension: 0.1
            },
            {
              label: 'Amortization Method',
              data: amortData.map(d => d.balance),
              borderColor: 'rgb(124, 58, 237)',
              backgroundColor: 'rgba(124, 58, 237, 0.1)',
              borderWidth: 2,
              pointRadius: 3,
              pointHoverRadius: 5,
              tension: 0.1
            },
            {
              label: 'Annuitization Method',
              data: annuitData.map(d => d.balance),
              borderColor: 'rgb(220, 38, 38)',
              backgroundColor: 'rgba(220, 38, 38, 0.1)',
              borderWidth: 2,
              pointRadius: 3,
              pointHoverRadius: 5,
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: {
                  size: 12,
                  family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              bodySpacing: 6,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += formatCurrency(context.parsed.y);
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Year',
                font: {
                  size: 13,
                  weight: '600'
                }
              },
              grid: {
                display: false
              }
            },
            y: {
              title: {
                display: true,
                text: 'Account Balance',
                font: {
                  size: 13,
                  weight: '600'
                }
              },
              beginAtZero: shouldBeginAtZero,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString('en-US', {maximumFractionDigits: 0});
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          }
        }
      });
    }

    function calculate() {
      const birthdate = document.getElementById("birthdate").value;
      const startDate = document.getElementById("startDate").value;
      const balance = parseFloat(document.getElementById("balance").value);
      const interestRate = parseFloat(document.getElementById("interestRate").value);
      const growthRate = parseFloat(document.getElementById("growthRate").value);
      const filingStatus = document.getElementById("filingStatus").value;
      const otherIncome = parseFloat(document.getElementById("otherIncome").value) || 0;
      const stateCode = document.getElementById("stateSelect").value;
      let tableType = document.getElementById("lifeExpTable").value;

      const noteEl = document.getElementById("tableNote");
      noteEl.classList.add("hidden");
      noteEl.textContent = "";

      if (!birthdate || !startDate || isNaN(balance) || balance <= 0) {
        alert("Please fill in all required fields with valid values.");
        return;
      }

      if (isNaN(interestRate) || interestRate < 0 || interestRate > 10) {
        alert("Please enter a valid interest rate between 0% and 10%.");
        return;
      }

      // Check if interest rate exceeds IRS maximum
      const afr = parseFloat(document.getElementById('currentAFR').value) || 0;
      const maxAllowed = Math.max(5.0, afr * 1.20);
      if (interestRate > maxAllowed) {
        if (!confirm(`Warning: Your interest rate (${interestRate.toFixed(2)}%) exceeds the IRS maximum allowed rate of ${maxAllowed.toFixed(2)}%.\n\nThis may not be compliant with IRS Notice 2022-6.\n\nContinue anyway?`)) {
          return;
        }
      }

      if (isNaN(growthRate) || growthRate < -10 || growthRate > 15) {
        alert("Please enter a valid growth rate between -10% and 15%.");
        return;
      }

      const age = calculateAge(birthdate, startDate);

      if (age >= 60) {
        if (!confirm("You are " + age + " years old. 72(t) SEPP is typically for those under 59¬Ω. Continue anyway?")) {
          return;
        }
      }

      if (age < 30) {
        if (!confirm("You are " + age + " years old. 72(t) SEPP is typically used closer to retirement age. Continue anyway?")) {
          return;
        }
      }

      // divisor / life expectancy
      let divisor = getDivisorOrLifeExpectancy(age, tableType);

      // If uniform selected but age < 72, CFR Table 2 has no divisor; fall back to single and warn.
      if (tableType === "uniform" && (divisor === null || divisor === undefined)) {
        tableType = "single";
        divisor = getDivisorOrLifeExpectancy(age, tableType);
        noteEl.textContent = "Note: The Uniform Lifetime Table divisor is only defined starting at age 72 in the CFR table. For ages under 72, this calculator falls back to the Single Life Table.";
        noteEl.classList.remove("hidden");
      }

      // Calculations
      const rmdAmount = calculateRMD(balance, divisor);
      const amortAmount = calculateAmortization(balance, divisor, interestRate);
      const annuitAmount = calculateAnnuitization(balance, age, interestRate);

      // SEPP duration
      const birthDateObj = new Date(birthdate + "T00:00:00");
      const startDateObj = new Date(startDate + "T00:00:00");

      const age59_5 = new Date(birthDateObj);
      age59_5.setFullYear(birthDateObj.getFullYear() + 59);
      age59_5.setMonth(birthDateObj.getMonth() + 6);

      const fiveYearsLater = new Date(startDateObj);
      fiveYearsLater.setFullYear(startDateObj.getFullYear() + 5);

      const seppEndDate = age59_5 > fiveYearsLater ? age59_5 : fiveYearsLater;
      const durationMs = seppEndDate.getTime() - startDateObj.getTime();
      const durationYears = durationMs / (365.25 * 24 * 60 * 60 * 1000);

      // Display
      document.getElementById("rmdAmount").textContent = formatCurrency(rmdAmount);
      document.getElementById("rmdMonthly").textContent = formatCurrency(rmdAmount / 12) + "/month";

      document.getElementById("amortAmount").textContent = formatCurrency(amortAmount);
      document.getElementById("amortMonthly").textContent = formatCurrency(amortAmount / 12) + "/month";

      document.getElementById("annuitAmount").textContent = formatCurrency(annuitAmount);
      document.getElementById("annuitMonthly").textContent = formatCurrency(annuitAmount / 12) + "/month";

      document.getElementById("calcAge").textContent = age + " years";
      document.getElementById("calcLifeExp").textContent = (typeof divisor === "number" ? divisor.toFixed(1) : "-");
      document.getElementById("calcRate").textContent = interestRate.toFixed(2) + "%";
      document.getElementById("calcBalance").textContent = formatCurrency(balance);

      const endDateStr = seppEndDate.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
      document.getElementById("seppDuration").textContent = durationYears.toFixed(1) + " years (until " + endDateStr + ")";

      const reason = age59_5 > fiveYearsLater ? "age 59¬Ω" : "5 years from start";
      document.getElementById("seppEndDate").textContent = "Ends at " + reason + ", whichever is later";

      // Set calculation timestamp
      const now = new Date();
      const timestampStr = now.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
      document.getElementById("calculationTimestamp").textContent = timestampStr;

      // Calculate and display tax impact
      const rmdTaxes = calculateTaxes(rmdAmount, otherIncome, filingStatus, stateCode);
      const amortTaxes = calculateTaxes(amortAmount, otherIncome, filingStatus, stateCode);
      const annuitTaxes = calculateTaxes(annuitAmount, otherIncome, filingStatus, stateCode);

      document.getElementById("taxFilingStatusDisplay").textContent = filingStatus === 'married' ? 'Married Filing Jointly' : 'Single';
      document.getElementById("taxStateDisplay").textContent = stateTaxRates[stateCode].name;

      document.getElementById("rmdAfterTax").textContent = formatCurrency(rmdTaxes.afterTaxIncome);
      document.getElementById("rmdAfterTaxMonthly").textContent = formatCurrency(rmdTaxes.afterTaxIncome / 12) + "/month";

      document.getElementById("amortAfterTax").textContent = formatCurrency(amortTaxes.afterTaxIncome);
      document.getElementById("amortAfterTaxMonthly").textContent = formatCurrency(amortTaxes.afterTaxIncome / 12) + "/month";

      document.getElementById("annuitAfterTax").textContent = formatCurrency(annuitTaxes.afterTaxIncome);
      document.getElementById("annuitAfterTaxMonthly").textContent = formatCurrency(annuitTaxes.afterTaxIncome / 12) + "/month";

      // Use average effective tax rate for display
      const avgEffectiveTaxRate = (rmdTaxes.effectiveTaxRate + amortTaxes.effectiveTaxRate + annuitTaxes.effectiveTaxRate) / 3;
      document.getElementById("effectiveTaxRate").textContent = avgEffectiveTaxRate.toFixed(2) + "%";

      // Show tax section
      document.getElementById("taxImpactSection").style.display = "block";

      // Display calculation breakdown
      const r = interestRate / 100;
      const pvFactor = r === 0 ? divisor : (1 - Math.pow(1 + r, -divisor)) / r;

      // Calculate annuity factor for display
      let survival = 1.0;
      let annuityFactor = 0.0;
      const startAge = Math.max(0, Math.min(120, Math.floor(age)));
      for (let t = 1; t <= 200; t++) {
        const currentAge = startAge + (t - 1);
        if (currentAge > 120) break;
        const qx = mortalityQx[currentAge];
        if (typeof qx !== "number") break;
        survival *= (1 - qx);
        const pv = r > 0 ? Math.pow(1 + r, -t) : 1.0;
        annuityFactor += survival * pv;
        if (survival < 1e-10) break;
      }

      const breakdownHTML = `
        <div style="margin-bottom: 1rem;">
          <strong>RMD Method:</strong><br>
          Annual Payment = $${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} √∑ ${divisor.toFixed(1)} = ${formatCurrency(rmdAmount)}
        </div>
        <div style="margin-bottom: 1rem;">
          <strong>Fixed Amortization Method:</strong><br>
          PV Factor = (1 - (1 + ${r.toFixed(4)})<sup>-${divisor.toFixed(1)}</sup>) / ${r.toFixed(4)} = ${pvFactor.toFixed(4)}<br>
          Annual Payment = $${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} √∑ ${pvFactor.toFixed(4)} = ${formatCurrency(amortAmount)}
        </div>
        <div>
          <strong>Fixed Annuitization Method:</strong><br>
          Annuity Factor (from CFR Table 4 mortality rates) = ${annuityFactor.toFixed(4)}<br>
          Annual Payment = $${balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} √∑ ${annuityFactor.toFixed(4)} = ${formatCurrency(annuitAmount)}
        </div>
      `;
      document.getElementById("calcBreakdown").innerHTML = breakdownHTML;

      // Update chart description with growth rate
      const chartDesc = document.getElementById("chartDescription");
      if (growthRate === 0) {
        chartDesc.textContent = "This chart shows how your account balance will change over the SEPP duration for each method, assuming 0% growth (conservative estimate). If your account depletes, the line will reach $0.";
      } else if (growthRate > 0) {
        chartDesc.textContent = `This chart shows how your account balance will change over the SEPP duration for each method, assuming ${growthRate.toFixed(1)}% annual growth. If your account depletes, the line will reach $0.`;
      } else {
        chartDesc.textContent = `This chart shows how your account balance will change over the SEPP duration for each method, assuming ${growthRate.toFixed(1)}% annual decline. If your account depletes, the line will reach $0.`;
      }

      // Generate projections for the chart
      const projectionYears = Math.ceil(durationYears);

      const rmdProjection = projectRMD(balance, age, projectionYears, growthRate, tableType);
      const amortProjection = projectFixedPayment(balance, amortAmount, projectionYears, growthRate);
      const annuitProjection = projectFixedPayment(balance, annuitAmount, projectionYears, growthRate);

      // Render the balance projection chart
      renderBalanceChart(rmdProjection, amortProjection, annuitProjection);

      document.getElementById("results").classList.remove("hidden");
      document.getElementById("results").scrollIntoView({ behavior: "smooth" });
    }

    function calculateReverse() {
      const birthdate = document.getElementById("reverseBirthdate").value;
      const startDate = document.getElementById("reverseStartDate").value;
      const targetIncome = parseFloat(document.getElementById("targetIncome").value);
      const interestRate = parseFloat(document.getElementById("reverseInterestRate").value);
      let tableType = document.getElementById("reverseLifeExpTable").value;

      const noteEl = document.getElementById("reverseTableNote");
      noteEl.classList.add("hidden");
      noteEl.textContent = "";

      // Validation
      if (!birthdate || !startDate || isNaN(targetIncome) || targetIncome <= 0) {
        alert("Please fill in all required fields with valid values.");
        return;
      }

      if (isNaN(interestRate) || interestRate < 0 || interestRate > 10) {
        alert("Please enter a valid interest rate between 0% and 10%.");
        return;
      }

      const age = calculateAge(birthdate, startDate);

      if (age >= 60) {
        if (!confirm("You are " + age + " years old. 72(t) SEPP is typically for those under 59¬Ω. Continue anyway?")) {
          return;
        }
      }

      if (age < 30) {
        if (!confirm("You are " + age + " years old. 72(t) SEPP is typically used closer to retirement age. Continue anyway?")) {
          return;
        }
      }

      // Get divisor / life expectancy
      let divisor = getDivisorOrLifeExpectancy(age, tableType);

      // If uniform selected but age < 72, fall back to single and warn
      if (tableType === "uniform" && (divisor === null || divisor === undefined)) {
        tableType = "single";
        divisor = getDivisorOrLifeExpectancy(age, tableType);
        noteEl.textContent = "Note: The Uniform Lifetime Table divisor is only defined starting at age 72 in the CFR table. For ages under 72, this calculator falls back to the Single Life Table.";
        noteEl.classList.remove("hidden");
      }

      // Reverse Calculations
      const rmdBalance = reverseCalculateRMD(targetIncome, divisor);
      const amortBalance = reverseCalculateAmortization(targetIncome, divisor, interestRate);
      const annuitBalance = reverseCalculateAnnuitization(targetIncome, age, interestRate);

      // Display results
      document.getElementById("reverseTargetDisplay").textContent = formatCurrency(targetIncome);

      document.getElementById("reverseRmdBalance").textContent = formatCurrency(rmdBalance);
      document.getElementById("reverseAmortBalance").textContent = formatCurrency(amortBalance);
      document.getElementById("reverseAnnuitBalance").textContent = formatCurrency(annuitBalance);

      document.getElementById("reverseCalcAge").textContent = age + " years";
      document.getElementById("reverseCalcLifeExp").textContent = (typeof divisor === "number" ? divisor.toFixed(1) : "-");
      document.getElementById("reverseCalcRate").textContent = interestRate.toFixed(2) + "%";
      document.getElementById("reverseCalcIncome").textContent = formatCurrency(targetIncome);

      // Display calculation breakdown
      const r = interestRate / 100;
      const pvFactor = r === 0 ? divisor : (1 - Math.pow(1 + r, -divisor)) / r;

      // Calculate annuity factor for display
      let survival = 1.0;
      let annuityFactor = 0.0;
      const startAge = Math.max(0, Math.min(120, Math.floor(age)));
      for (let t = 1; t <= 200; t++) {
        const currentAge = startAge + (t - 1);
        if (currentAge > 120) break;
        const qx = mortalityQx[currentAge];
        if (typeof qx !== "number") break;
        survival *= (1 - qx);
        const pv = r > 0 ? Math.pow(1 + r, -t) : 1.0;
        annuityFactor += survival * pv;
        if (survival < 1e-10) break;
      }

      const reverseBreakdownHTML = `
        <div style="margin-bottom: 1rem;">
          <strong>RMD Method:</strong><br>
          Required Balance = ${formatCurrency(targetIncome)} √ó ${divisor.toFixed(1)} = ${formatCurrency(rmdBalance)}
        </div>
        <div style="margin-bottom: 1rem;">
          <strong>Fixed Amortization Method:</strong><br>
          PV Factor = (1 - (1 + ${r.toFixed(4)})<sup>-${divisor.toFixed(1)}</sup>) / ${r.toFixed(4)} = ${pvFactor.toFixed(4)}<br>
          Required Balance = ${formatCurrency(targetIncome)} √ó ${pvFactor.toFixed(4)} = ${formatCurrency(amortBalance)}
        </div>
        <div>
          <strong>Fixed Annuitization Method:</strong><br>
          Annuity Factor (from CFR Table 4 mortality rates) = ${annuityFactor.toFixed(4)}<br>
          Required Balance = ${formatCurrency(targetIncome)} √ó ${annuityFactor.toFixed(4)} = ${formatCurrency(annuitBalance)}
        </div>
      `;
      document.getElementById("reverseCalcBreakdown").innerHTML = reverseBreakdownHTML;

      document.getElementById("reverseResults").classList.remove("hidden");
      document.getElementById("reverseResults").scrollIntoView({ behavior: "smooth" });
    }
  </script>
</body>
</html>
